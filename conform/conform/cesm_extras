#! /usr/bin/env python

import json, os
import argparse

time = {
           'atmos': 'chunits(mean(time_bnds, \"nbnd\"), units=time)',
           'aerosol': 'chunits(mean(time_bnds, \"nbnd\"), units=time)',
           'atmosChem': 'chunits(mean(time_bnds, \"nbnd\"), units=time)',
           'ocean': 'mean(chunits(time_bound, units=time), \"d2\")',
           'ocnBgChem': 'mean(chunits(time_bound, units=time), \"d2\")',
           'seaIce': 'mean(chunits(time_bounds, units=time), \"d2\")',
           'land': 'mean(chunits(time_bounds, units=time), \"hist_interval\")',
           'landIce': 'mean(chunits(time_bounds, units=time), \"hist_interval\")',
       }
bounds = {
           'atmos': 'time_bnds',
           'aerosol': 'time_bnds',
           'atmosChem': 'time_bnds',
           'ocean': 'time_bound',
           'ocnBgChem': 'time_bound',
           'seaIce': 'time_bounds',
           'land': 'time_bounds',
           'landIce': 'time_bounds',
       }

comps = {'atmos': 'atm',
           'aerosol': 'atm',
           'atmosChem': 'atm',
           'ocean': 'ocn',
           'ocnBgChem': 'ocn',
           'seaIce': 'ice',
           'land': 'lnd',
           'landIce': 'glc',
       }


#===================================================================================================
# Command-line Interface
#===================================================================================================
def cli(argv=None):

    desc = """This tool adds information to the json files created by iconform to fill in the gaps
              between the informaiton that we can retreive from the request and what ultimately 
              needs to be in the final netcdf output files.  This is internal knowledge and specific
              to CESM data."""
    parser = argparse.ArgumentParser(description=desc)

    parser.add_argument('-e', '--extra', default='extra_vars.json', type=str, 
                        help='Filename of json file that contains the extra definitions to use.')

    parser.add_argument('ifiles', metavar='INFILE', nargs='*', type=str, help='String that points to json files generated by pyconform.  Can contain wildcards.')

    return parser.parse_args(argv)

#===================================================================================================
# Main Script Function
#===================================================================================================
def main(argv=None):

    args = cli(argv)
   
    # Get list of inputs 
    ifiles = args.ifiles

    # Get the 'extra' json filename and load it
    efile_base = args.extra

    # Go through each of the jsons created by iconform that the user wants to modify
    for fn in ifiles:
        fsplit = os.path.basename(fn).split('_')
        freq = fsplit[2] 
        realm = fsplit[3]
        # open extra file
        e_path = os.path.dirname(efile_base)
        e_fn = os.path.basename(efile_base)
        if len(realm)>0:
            extra_file = e_path+"/"+comps[realm]+"_"+e_fn
        else:
            extra_file = e_path+"/"+e_fn  
        with open(extra_file) as e:
            e_dict = json.load(e)
        print "\nOpening ",fn
        # Open and load
        with open(fn) as f:       
            o_dict = json.load(f)
        o_dict_copy = o_dict.copy()
 
        # Go through the original to find things that we have to add and/or change
        cvar = fn.split("_")[-2]
        cr = fn.split("_")[-3]
        for var,d1 in o_dict_copy.iteritems():
            if "definition" in d1.keys():
                if 'vinth2p' in d1["definition"]:
                    if 'alevel' in d1["definition"]:
                        o_dict[var]["definition"] = o_dict[var]["definition"].replace('alevel','lev')
            if cvar in var and ('ocean' in cr or 'ocn' in cr):
                if "nlat" in e_dict.keys():
                    o_dict["nlat"] = e_dict["nlat"]
                if "nlon" in e_dict.keys():
                    o_dict["nlon"] = e_dict["nlon"]
            if 'bounds' in d1["attributes"].keys():
                 if d1["attributes"]["bounds"] not in o_dict.keys():
                     o_dict[d1["attributes"]["bounds"]] = e_dict[d1["attributes"]["bounds"]]
                     print "Added ", d1["attributes"]["bounds"]
                 if var == 'time' and len(realm)>0:
                     o_dict[d1["attributes"]["bounds"]]["definition"] = bounds[realm]
            if "alevhalf" in d1["dimensions"] and "alevhalf" != var:
                o_dict[var]["metavars"] = ["ps", "p0", "a", "b"]
                print "Added metavars ps, p0, a, and b to variable, ",var
                if "p0" not in o_dict.keys():
                    o_dict["p0"] = e_dict["p0"]
                    print "Added p0"
                if "a" not in o_dict.keys():
                    o_dict["a"] = e_dict["a"]
                    print "Added a"
                if "a_bnds" not in o_dict.keys():
                    o_dict["a_bnds"] = e_dict["a_bnds"]
                    print "Added a_bnds"
                if "b" not in o_dict.keys():
                    o_dict["b"] = e_dict["b"]
                    print "Added b"
                if "b_bnds" not in o_dict.keys():
                    o_dict["b_bnds"] = e_dict["b_bnds"]
                    print "Added b_bnds"
            if "alevel" in d1["dimensions"] and "alevel" != var:
                o_dict[var]["metavars"] = ["ps", "p0"]
                print "Added metavars ps and p0 to variable, ",var
                if "p0" not in o_dict.keys():
                    o_dict["p0"] = e_dict["p0"]
                    print "Added p0"
            if var == 'time':
                 if 'mon' in freq:
                     o_dict[var]["definition"] = time[realm] 
            if var == 'alevel' or var == 'alevhalf':
                o_dict[var]["attributes"]["units"] = "hPa"
            if var == 'olevel' or var == 'oline':
                o_dict[var]["attributes"]["units"] = "centimeters"
        # Rewrite the file
        with open(fn, 'w') as outfile:
            json.dump(o_dict, outfile, sort_keys=True, indent=4)

    print("FINISHED 2nd WRITE OF JSON FILES")

#===================================================================================================
# Command-line Operation
#===================================================================================================
if __name__ == '__main__':
    main()

